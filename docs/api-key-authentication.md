# API Key Authentication Implementation

## Overview

This document explains how API key authentication is implemented in the HealFlow frontend application to communicate securely with the Spring Boot backend API.

## Architecture

The implementation uses **request interceptors** on the auto-generated API client to automatically inject API key headers for specific endpoints.

### Key Components

1. **API Client Configuration** (`src/lib/api-client.ts`)
   - Configures request interceptor for API key authentication
   - Identifies endpoints requiring API key (specialists, user provisioning)
   - Reads API key from environment variables (server-side only)

2. **Client Auth Configuration** (`src/lib/client-auth-config.ts`)
   - Imports and initializes API key interceptor
   - Configures JWT Bearer token for authenticated user requests
   - Handles both API key and Bearer token authentication

3. **Auto-Generated Client** (`src/client/`)
   - Generated by HeyAPI from OpenAPI specification
   - Should **never be modified directly**
   - Extended through interceptors and configuration

## How It Works

### Request Flow

1. **App Initialization**
   - `__root.tsx` imports `client-auth-config.ts`
   - `configureApiKeyInterceptor()` is called automatically
   - Interceptor is registered with the HTTP client

2. **Making Requests**

   ```typescript
   // In your component
   const { data } = useQuery(
     getAvailableSpecialistsOptions({
       query: { type: "GENERAL_PRACTICE" },
     }),
   );
   ```

3. **Interceptor Logic**
   - Request interceptor checks if URL matches API key endpoints
   - If matched, adds `X-API-KEY` header with value from environment
   - If not matched, proceeds with normal authentication (Bearer token)

### Protected Endpoints

The following endpoints require API key authentication:

- `GET /api/v1/specialists` - Fetch available specialists
- `POST /api/v1/user-provisions` - Provision new users
- `POST /api/v1/user-provisions/validate` - Validate user IDs

## Environment Configuration

### Required Environment Variables

```bash
# API Service Key (shared secret with backend)
API_SERVICE_KEY=your-api-service-key-here

# API Key Header Name (optional, defaults to X-API-KEY)
API_KEY_HEADER_NAME=X-API-KEY
```

### Backend Configuration

The Spring Boot API must be configured with the same API key:

**application.yml:**

```yaml
api:
  key: your-api-service-key-here
  key-header: X-API-KEY
  key-path: /specialists/**,/user-provisions/**
```

## Security Considerations

1. **Server-Side Only**: API key is only accessible on the server-side (Node.js runtime)
2. **Never Exposed to Browser**: Environment variables are not bundled into client JavaScript
3. **Endpoint-Specific**: API key is only added to specific endpoints, not all requests
4. **Dual Authentication**: System supports both API key and JWT Bearer tokens

## Usage Examples

### Fetching Specialists

```typescript
// Component code (no manual headers needed)
import { useQuery } from "@tanstack/react-query";
import { getAvailableSpecialistsOptions } from "@/client";

function SpecialistSelector() {
  const { data: specialists } = useQuery(
    getAvailableSpecialistsOptions({
      query: { type: "GENERAL_PRACTICE" }
    })
  );

  // API key is automatically added by interceptor
  return (
    <select>
      {specialists?.map(s => (
        <option key={s.id} value={s.id}>{s.name}</option>
      ))}
    </select>
  );
}
```

### Provisioning Users

```typescript
// Server function (Effect.js pattern)
import { Effect } from "effect";
import { UserRegistrationService } from "@/services/user-registration.service";
import { apiKeyConfig } from "@/lib/api-key.config";

const service = new UserRegistrationService(apiKeyConfig);

await Effect.runPromise(
  service.post({
    user_id: userId,
    email: email,
    specialist_id: specialistId,
  }),
);
```

## Regenerating the Client

When the backend API changes:

```bash
# Regenerate client from OpenAPI spec
bun run openapi-ts
```

**Important**: Never modify files in `src/client/` directly. All customization should be done through:

- Environment variables
- Interceptors (src/lib/api-client.ts)
- Service wrappers (src/services/)

## Troubleshooting

### "API requests requiring API key authentication may fail"

**Cause**: `API_SERVICE_KEY` environment variable is not set.

**Solution**: Add to `.env` file:

```bash
API_SERVICE_KEY=your-actual-key-here
```

### 401 Unauthorized on specialists endpoint

**Cause**: API key mismatch between frontend and backend.

**Solution**: Ensure both services use the same key:

- Frontend: `API_SERVICE_KEY` in `.env`
- Backend: `api.key` in `application.yml`

### API key exposed in browser console

**Cause**: Logging is enabled in production.

**Solution**: The implementation only logs on server-side. Check that you're not running development mode in production.

## Testing

### Verify API Key is Added

Check server logs for:

```
[API Client] API key interceptor configured
[API Client] âœ“ API key added for: http://localhost:8080/api/v1/specialists
```

### Test Specialists Endpoint

```bash
# With correct API key
curl -H "X-API-KEY: your-key" http://localhost:8080/api/v1/specialists

# Should return 200 OK with specialists list
```

## Related Files

- `src/lib/api-client.ts` - API key interceptor configuration
- `src/lib/client-auth-config.ts` - Combined auth configuration
- `src/lib/api-key.config.ts` - Effect.js API key configuration (legacy)
- `src/services/user-registration.service.ts` - User provisioning service
- `src/services/user-sync.service.ts` - User synchronization service
- `src/routes/__root.tsx` - App entry point (loads config)

## Migration Notes

### From Manual Headers to Interceptor

**Before:**

```typescript
await provisionUser({
  body: userData,
  headers: {
    "X-API-KEY": process.env.API_SERVICE_KEY,
  },
});
```

**After:**

```typescript
// Headers added automatically
await provisionUser({
  body: userData,
});
```

The interceptor approach is cleaner and ensures consistency across all requests.
